<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الكرة في الأغواط</title>
    <link rel="icon" href="https://i.top4top.io/p_3636li6n50.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-green: #006039;
            --accent-green: #27ae60;
            --text-dark: #1f2937;
            --text-grey: #6b7280;
            --live-red: #e74c3c;
            --bg-light: #f8f9fa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; color: var(--text-dark); }

        /* الهيدر */
        .navbar {
            background-color: #fff; padding: 15px; display: flex;
            justify-content: center; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100;
        }
        .logo-area { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1.3rem; color: var(--primary-green); }
        .logo-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-green); }

        /* الهيرو */
        .hero {
            background: linear-gradient(135deg, var(--primary-green), #0b3d29);
            color: white; text-align: center; padding: 40px 20px 60px;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        }
        .hero h1 { font-size: 2rem; margin-bottom: 5px; font-weight: 800; }
        .hero p { font-size: 0.9rem; opacity: 0.8; }

        /* الحاوية */
        .container { max-width: 800px; margin: -40px auto 50px; padding: 0 15px; position: relative; z-index: 2; }
        
        /* بطاقة الدوري */
        .league-card { 
            background: white; border-radius: 16px; margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #edf2f7;
        }
        .league-header {
            background: #fff; padding: 15px 20px; border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .league-title { font-weight: 800; color: var(--primary-green); display: flex; align-items: center; gap: 8px; font-size: 1rem; }
        .league-title i { color: #f1c40f; }
        .league-round { font-size: 0.75rem; background: #f3f4f6; padding: 4px 10px; border-radius: 20px; color: #666; font-weight: bold; }

        /* --- تنسيق صف المباراة --- */
        .match-row {
            display: flex; align-items: center; padding: 15px 10px;
            border-bottom: 1px solid #f8fafc; height: 90px;
        }
        .match-row:last-child { border-bottom: none; }

        /* الفريق */
        .team { 
            flex: 1; display: flex; align-items: center; gap: 10px; 
            font-size: 0.95rem; font-weight: 700; color: #2d3748; 
        }
        .team.home { justify-content: flex-start; }
        .team.away { justify-content: flex-end; text-align: right; }
        
        .team img { 
            width: 40px; height: 40px; object-fit: contain; 
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
        }

        /* منطقة الوسط (النتيجة والوقت) */
        .match-center {
            width: 100px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }

        /* النتيجة */
        .score {
            font-size: 1.8rem; font-weight: 900; color: #1a202c;
            line-height: 1; letter-spacing: 2px; margin-bottom: 4px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .score.live { color: var(--accent-green); }

        /* حاوية المعلومات السفلية (الوقت + مباشر) */
        .meta-info {
            display: flex; align-items: center; justify-content: center; gap: 6px;
            font-size: 0.75rem; font-weight: 700; color: var(--text-grey);
        }

        /* الوقت */
        .match-time { direction: ltr; font-variant-numeric: tabular-nums; }
        .match-time.live { color: var(--live-red); }

        /* أيقونة المباشر */
        .live-dot {
            width: 6px; height: 6px; background-color: var(--live-red);
            border-radius: 50%; display: none;
        }
        .live-dot.active { display: block; animation: blink 1s infinite; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }

        /* الفوتر */
        footer { margin-top: 50px; text-align: center; color: #888; font-size: 0.8rem; padding-bottom: 20px; }

        /* تجاوب للموبايل */
        @media (max-width: 450px) {
            .team { font-size: 0.8rem; flex-direction: column; gap: 5px; text-align: center !important; }
            .team.home { flex-direction: column-reverse; }
            .team.away { flex-direction: column; }
            .match-row { height: auto; padding: 20px 5px; }
            .match-center { width: 80px; }
            .score { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo-area">
            <img src="https://i.top4top.io/p_3636li6n50.jpg" class="logo-img">
            <span>الكرة في الأغواط</span>
        </div>
    </nav>

    <section class="hero">
        <h1>نتائج المباريات</h1>
        <p>تغطية حصرية لبطولات الولاية والجنوب</p>
    </section>

    <div class="container">
        <div id="matches-container">
            <div style="text-align:center; padding:40px; color:#888;">
                <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><br><br>جاري جلب المباريات...
            </div>
        </div>
    </div>

    <footer>
        <p>جميع الحقوق محفوظة © 2024</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAXLSZ5OqPEOnP0DUx3w75fU2xxiVkrWcE",
          authDomain: "koooralaghouat.firebaseapp.com",
          projectId: "koooralaghouat",
          storageBucket: "koooralaghouat.firebasestorage.app",
          messagingSenderId: "84750708348",
          appId: "1:84750708348:web:179ec7acf8fc2f357e23f9",
          measurementId: "G-4YSP7SWPGV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- إصلاح دالة الوقت لتجنب NaN ---
        function formatTime(totalSeconds) {
            // إذا كان الرقم غير موجود أو ليس رقماً، نعتبره صفر
            if (!totalSeconds || isNaN(totalSeconds)) {
                totalSeconds = 0;
            }
            if (totalSeconds < 0) totalSeconds = 0;
            
            const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const s = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        onSnapshot(collection(db, "matches"), (snapshot) => {
            const container = document.getElementById("matches-container");
            container.innerHTML = "";
            
            if(snapshot.empty) {
                container.innerHTML = "<div style='text-align:center; padding:20px; color:#666;'>لا توجد مباريات حالياً</div>";
                return;
            }

            const leagues = {};
            snapshot.forEach((doc) => {
                const m = doc.data();
                if (!leagues[m.league]) leagues[m.league] = [];
                leagues[m.league].push(m);
            });

            for (const [leagueName, matches] of Object.entries(leagues)) {
                let cardHtml = `
                <div class="league-card">
                    <div class="league-header">
                        <div class="league-title">
                            <i class="fa-solid fa-trophy"></i> ${leagueName}
                        </div>
                        <div class="league-round">${matches[0].round || 'مباراة'}</div>
                    </div>
                    <div>`;

                matches.forEach(m => {
                    // --- التأكد من أن الثواني رقم صحيح (إصلاح المشكلة) ---
                    let currentSeconds = m.elapsedSeconds || 0;
                    
                    if(m.isRunning && m.lastStartTime) {
                        const now = Date.now();
                        currentSeconds += (now - m.lastStartTime) / 1000;
                    }

                    // الحالة
                    let isLive = m.isRunning || m.status.includes("الشوط");
                    let statusText = m.status; 
                    
                    let timeClass = "";
                    let scoreClass = "";
                    let dotClass = "";
                    let timerData = "";

                    if (isLive) {
                        statusText = formatTime(currentSeconds);
                        timeClass = "live match-timer-active";
                        scoreClass = "live";
                        dotClass = "active";
                        
                        timerData = `
                            data-running="${m.isRunning}" 
                            data-start="${m.lastStartTime}" 
                            data-base="${m.elapsedSeconds || 0}"
                        `;
                    }
                    
                    // نصوص الحالات الأخرى
                    if(m.status.includes("استراحة")) statusText = "استراحة";
                    if(m.status.includes("نهاية")) statusText = "نهاية";
                    if(m.status.includes("لم تبدأ")) statusText = "--:--";

                    cardHtml += `
                        <div class="match-row">
                            <!-- المستضيف (يمين) -->
                            <div class="team home">
                                <img src="${m.homeLogo}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/53/53283.png'">
                                <span>${m.home}</span>
                            </div>

                            <!-- الوسط: النتيجة وتحتها الوقت -->
                            <div class="match-center">
                                <div class="score ${scoreClass}">${m.scoreA} - ${m.scoreH}</div>
                                <div class="meta-info">
                                    <div class="live-dot ${dotClass}"></div>
                                    <div class="match-time ${timeClass}" ${timerData}>${statusText}</div>
                                </div>
                            </div>

                            <!-- الضيف (يسار) -->
                            <div class="team away">
                                <span>${m.away}</span>
                                <img src="${m.awayLogo}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/53/53283.png'">
                            </div>
                        </div>`;
                });

                cardHtml += `</div></div>`;
                container.innerHTML += cardHtml;
            }
        });

        // العداد المحلي السلس
        setInterval(() => {
            const timers = document.querySelectorAll('.match-timer-active');
            const now = Date.now();
            
            timers.forEach(timer => {
                const isRunning = timer.getAttribute('data-running') === 'true';
                if (isRunning) {
                    const startTime = parseInt(timer.getAttribute('data-start'));
                    // معالجة حالة الرقم غير الموجود (NaN protection)
                    let baseSeconds = parseInt(timer.getAttribute('data-base'));
                    if (isNaN(baseSeconds)) baseSeconds = 0;
                    
                    if (!isNaN(startTime)) {
                        const diffSeconds = (now - startTime) / 1000;
                        const totalSeconds = baseSeconds + diffSeconds;
                        timer.innerText = formatTime(totalSeconds);
                    }
                }
            });
        }, 1000);

    </script>
</body>
</html>