<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>نظام المسابقات الرسمي - الجزائر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f8fafc; }
        input, select { @apply w-full p-3 rounded-xl border-2 border-slate-200 focus:border-blue-600 outline-none transition-all font-bold bg-white text-slate-700; }
        label { @apply block text-sm font-black text-slate-700 mb-2 mr-1; }
        .section-card { @apply bg-white p-6 md:p-8 rounded-[2.5rem] shadow-xl border border-slate-100 mb-8 fade-in; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar-btn { @apply flex items-center justify-between w-full p-4 rounded-2xl font-bold transition-all mb-2; }
        .tab-active { @apply bg-blue-600 text-white shadow-xl; }
        .tab-inactive { @apply text-slate-500 hover:bg-white hover:text-blue-600; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
          apiKey: "AIzaSyBdlRDPTQqY8lZvD4R7nneXAwPgRbxmm14",
          authDomain: "councour-59e43.firebaseapp.com",
          projectId: "councour-59e43",
          storageBucket: "councour-59e43.firebasestorage.app",
          messagingSenderId: "492907661374",
          appId: "1:492907661374:web:31792fc3ab95d0e69ea96f"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // بيانات الولايات والبلديات (مختصرة للعرض)
        const algeriaData = {
            "16- الجزائر": ["بلدية سيدي امحمد", "بلدية الدار البيضاء", "بلدية الشراقة"],
            "17- الجلفة": ["بلدية الجلفة", "بلدية عين وسارة", "بلدية حاسي بحبح"],
            "31- وهران": ["بلدية وهران", "بلدية بئر الجير", "بلدية السانيا"]
        };

        const App = () => {
            const [view, setView] = useState('user'); 
            const [isLoggedIn, setIsLoggedIn] = useState(false);

            useEffect(() => {
                auth.onAuthStateChanged(user => setIsLoggedIn(!!user));
            }, []);

            return (
                <div className="min-h-screen flex flex-col">
                    <nav className="h-20 bg-slate-900 text-white flex items-center justify-between px-6 sticky top-0 z-50 shadow-2xl">
                        <div className="flex items-center gap-3">
                            <i className="fa-solid fa-gavel text-blue-400 text-2xl"></i>
                            <h1 className="font-black text-lg md:text-xl">بوابة المسابقات الرسمية</h1>
                        </div>
                        <button onClick={() => setView(view === 'user' ? 'admin' : 'user')} className="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl font-bold text-xs transition-all">
                            {view === 'user' ? 'لوحة التحكم' : 'عرض الاستمارة'}
                        </button>
                    </nav>

                    {view === 'user' ? <UserView /> : (isLoggedIn ? <AdminDashboard /> : <AdminLogin />)}
                </div>
            );
        };

        const UserView = () => {
            const [step, setStep] = useState(1);
            const [f, setF] = useState({});
            const [loading, setLoading] = useState(false);

            const updateF = (key, val) => setF({...f, [key]: val});

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await db.collection("candidates").add({
                        ...f, 
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("✅ تم إرسال طلبكم بنجاح!");
                    setF({}); setStep(1);
                } catch (err) { alert("❌ خطأ في الإرسال"); }
                setLoading(false);
            };

            return (
                <div className="max-w-4xl mx-auto mt-8 px-4 pb-20">
                    <div className="flex justify-between mb-8 px-4 relative">
                        {[1, 2, 3].map(s => (
                            <div key={s} className={`w-10 h-10 rounded-full flex items-center justify-center font-bold z-10 ${step >= s ? 'bg-blue-600 text-white' : 'bg-white text-slate-400 border-2'}`}>
                                {s}
                            </div>
                        ))}
                        <div className="absolute top-1/2 left-0 w-full h-0.5 bg-slate-200 -z-0"></div>
                    </div>

                    <form onSubmit={handleSubmit}>
                        {step === 1 && (
                            <div className="section-card">
                                <h3 className="text-xl font-black mb-6 border-b pb-2 text-blue-600">1. المعلومات الشخصية (حسب الوثيقة)</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="md:col-span-2">
                                        <label>رقم التعريف الوطني (NIN)</label>
                                        <input required placeholder="18 رقم" maxLength="18" value={f.nin || ''} onChange={e=>updateF('nin', e.target.value)} />
                                    </div>
                                    <input placeholder="اللقب بالعربية" required onChange={e=>updateF('lastNameAr', e.target.value)} />
                                    <input placeholder="الاسم بالعربية" required onChange={e=>updateF('firstNameAr', e.target.value)} />
                                    <input placeholder="اللقب باللاتينية" required onChange={e=>updateF('lastNameEn', e.target.value)} />
                                    <input placeholder="الاسم باللاتينية" required onChange={e=>updateF('firstNameEn', e.target.value)} />
                                    <select required onChange={e=>updateF('state', e.target.value)}>
                                        <option value="">اختر الولاية...</option>
                                        {Object.keys(algeriaData).map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <select required disabled={!f.state} onChange={e=>updateF('city', e.target.value)}>
                                        <option value="">اختر البلدية...</option>
                                        {f.state && algeriaData[f.state].map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div className="mt-8 flex justify-end"><button type="button" onClick={()=>setStep(2)} className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold">التالي</button></div>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="section-card">
                                <h3 className="text-xl font-black mb-6 border-b pb-2 text-blue-600">2. المسار الدراسي والخدمة الوطنية</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <select required onChange={e=>updateF('service', e.target.value)}>
                                        <option value="">وضعية الخدمة الوطنية...</option>
                                        <option>مؤدى</option><option>معفى</option><option>مؤجل</option>
                                    </select>
                                    <input type="date" required onChange={e=>updateF('serviceDate', e.target.value)} />
                                    <input placeholder="تسمية الشهادة" required className="md:col-span-2" onChange={e=>updateF('degree', e.target.value)} />
                                    <input placeholder="التخصص" required onChange={e=>updateF('specialty', e.target.value)} />
                                    <input placeholder="المؤسسة المسلمة" required onChange={e=>updateF('university', e.target.value)} />
                                </div>
                                <div className="mt-8 flex justify-between">
                                    <button type="button" onClick={()=>setStep(1)} className="bg-slate-200 px-8 py-3 rounded-xl font-bold">السابق</button>
                                    <button type="button" onClick={()=>setStep(3)} className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold">التالي</button>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="section-card text-center">
                                <i className="fa-solid fa-clipboard-check text-6xl text-green-500 mb-4"></i>
                                <h3 className="text-2xl font-black mb-4">تأكيد البيانات</h3>
                                <p className="text-slate-500 mb-8 text-sm">أصرح بشرفي بصحة المعلومات المقدمة في هذه الاستمارة.</p>
                                <div className="flex justify-between">
                                    <button type="button" onClick={()=>setStep(2)} className="bg-slate-200 px-8 py-3 rounded-xl font-bold">السابق</button>
                                    <button type="submit" disabled={loading} className="bg-green-600 text-white px-12 py-3 rounded-xl font-black text-lg">
                                        {loading ? "جاري الإرسال..." : "إرسال الطلب"}
                                    </button>
                                </div>
                            </div>
                        )}
                    </form>
                </div>
            );
        };

        const AdminDashboard = () => {
            const [candidates, setCandidates] = useState([]);
            const [activeTab, setActiveTab] = useState('all');

            useEffect(() => {
                const unsub = db.collection("candidates").orderBy("submittedAt", "desc").onSnapshot(snap => {
                    setCandidates(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsub;
            }, []);

            return (
                <div className="flex flex-1 flex-col md:flex-row">
                    <aside className="w-full md:w-72 bg-white border-l p-6">
                        <button onClick={()=>setActiveTab('all')} className={`sidebar-btn ${activeTab === 'all' ? 'tab-active' : 'tab-inactive'}`}>
                            <span><i className="fa-solid fa-users ml-2"></i> المترشحين</span>
                        </button>
                        <button onClick={()=>auth.signOut()} className="sidebar-btn text-red-500 mt-10">خروج</button>
                    </aside>

                    <main className="flex-1 p-6 md:p-10">
                        <div className="bg-white rounded-3xl shadow-xl overflow-hidden border">
                            <div className="overflow-x-auto">
                                <table className="w-full text-right border-collapse">
                                    <thead className="bg-slate-900 text-white">
                                        <tr>
                                            <th className="p-4 text-xs whitespace-nowrap">NIN</th>
                                            <th className="p-4 text-xs">الاسم واللقب</th>
                                            <th className="p-4 text-xs">الولاية/البلدية</th>
                                            <th className="p-4 text-xs">الشهادة</th>
                                            <th className="p-4 text-xs">الخدمة الوطنية</th>
                                            <th className="p-4 text-xs">الإجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {candidates.map(c => (
                                            <tr key={c.id} className="border-b hover:bg-slate-50 transition-colors">
                                                <td className="p-4 font-mono text-xs">{c.nin}</td>
                                                <td className="p-4 font-bold text-sm">{c.firstNameAr} {c.lastNameAr}</td>
                                                <td className="p-4 text-xs">{c.state} <br/> <span className="text-blue-500">{c.city}</span></td>
                                                <td className="p-4 text-xs font-bold">{c.degree}</td>
                                                <td className={`p-4 text-xs font-black ${c.service === 'مؤدى' ? 'text-green-600' : 'text-orange-600'}`}>{c.service}</td>
                                                <td className="p-4">
                                                    <button onClick={()=>db.collection("candidates").doc(c.id).delete()} className="text-red-400 hover:text-red-600">
                                                        <i className="fa-solid fa-trash-can"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const AdminLogin = () => {
            const [e, setE] = useState(''); const [p, setP] = useState('');
            return (
                <div className="max-w-md mx-auto mt-20 p-8 bg-white rounded-[2.5rem] shadow-2xl border w-11/12">
                    <h2 className="text-2xl font-black text-center mb-8">تسجيل دخول الإدارة</h2>
                    <form onSubmit={async(x)=>{x.preventDefault(); try{await auth.signInWithEmailAndPassword(e, p)}catch(err){alert("خطأ في الدخول")}} } className="space-y-4">
                        <input type="email" placeholder="البريد الإلكتروني" onChange={v=>setE(v.target.value)} />
                        <input type="password" placeholder="كلمة المرور" onChange={v=>setP(v.target.value)} />
                        <button className="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-lg">دخول</button>
                    </form>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
