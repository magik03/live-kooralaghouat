<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>نظام المسابقات - إدارة القوائم الديناميكية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; }
        input, select { border: 2px solid #cbd5e1; padding: 0.6rem; border-radius: 0.5rem; width: 100%; margin-top: 0.2rem; }
        .admin-table th { background-color: #1e293b; color: white; padding: 12px; text-align: right; border: 1px solid #334155; }
        .admin-table td { padding: 10px; border: 1px solid #e2e8f0; }
        .tab-btn { padding: 10px 20px; font-weight: bold; border-radius: 8px; transition: 0.3s; }
        .active-tab { background-color: #2563eb; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
          apiKey: "AIzaSyBdlRDPTQqY8lZvD4R7nneXAwPgRbxmm14",
          authDomain: "councour-59e43.firebaseapp.com",
          projectId: "councour-59e43",
          storageBucket: "councour-59e43.firebasestorage.app",
          messagingSenderId: "492907661374",
          appId: "1:492907661374:web:31792fc3ab95d0e69ea96f",
          measurementId: "G-2NLB5H3NQH"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const App = () => {
            const [view, setView] = useState('user'); 
            const [isLoggedIn, setIsLoggedIn] = useState(false);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(user => setIsLoggedIn(!!user));
                return unsub;
            }, []);

            return (
                <div className="min-h-screen">
                    <nav className="bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-50 shadow-xl">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center font-black">M</div>
                            <h1 className="font-black text-lg">بوابة المسابقات</h1>
                        </div>
                        <button 
                            onClick={() => setView(view === 'user' ? 'admin' : 'user')}
                            className="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded-lg font-bold text-sm transition shadow-lg"
                        >
                            {view === 'user' ? 'لوحة الإدارة' : 'الرجوع للاستمارة'}
                        </button>
                    </nav>

                    {view === 'user' ? <UserForm /> : (isLoggedIn ? <AdminPanel /> : <AdminLogin />)}
                </div>
            );
        };

        // --- 1. استمارة المستخدم (تحمل القوائم من Firebase) ---
        const UserForm = () => {
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState(false);
            const [lists, setLists] = useState({ ranks: [], subjects: [] });
            const [formData, setFormData] = useState({ nin: '', firstName: '', lastName: '', rank: '', subject: '', phone: '' });

            useEffect(() => {
                db.collection("settings").doc("lists").onSnapshot(doc => {
                    if (doc.exists) setLists(doc.data());
                });
            }, []);

            const submitForm = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await db.collection("candidates").add({ ...formData, submittedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    setSuccess(true);
                } catch (err) { alert("خطأ في الحفظ"); } finally { setLoading(false); }
            };

            if (success) return <div className="p-20 text-center"><h2 className="text-2xl font-black">✅ تم التسجيل بنجاح!</h2><button onClick={() => setSuccess(false)} className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg">تسجيل مترشح آخر</button></div>;

            return (
                <div className="max-w-2xl mx-auto py-10 px-4">
                    <form onSubmit={submitForm} className="bg-white p-8 rounded-2xl shadow-xl space-y-4">
                        <h2 className="text-xl font-black border-r-4 border-blue-600 pr-3">استمارة المترشح</h2>
                        <input type="text" placeholder="رقم التعريف الوطني (NIN)" required onChange={e => setFormData({...formData, nin: e.target.value})} />
                        <div className="grid grid-cols-2 gap-4">
                            <input type="text" placeholder="الاسم" required onChange={e => setFormData({...formData, firstName: e.target.value})} />
                            <input type="text" placeholder="اللقب" required onChange={e => setFormData({...formData, lastName: e.target.value})} />
                        </div>
                        
                        <label className="text-xs font-bold text-slate-500">اختر الرتبة المطلوبة:</label>
                        <select required onChange={e => setFormData({...formData, rank: e.target.value})}>
                            <option value="">-- اختر الرتبة --</option>
                            {lists.ranks?.map(r => <option key={r} value={r}>{r}</option>)}
                        </select>

                        <label className="text-xs font-bold text-slate-500">اختر المادة / التخصص:</label>
                        <select required onChange={e => setFormData({...formData, subject: e.target.value})}>
                            <option value="">-- اختر التخصص --</option>
                            {lists.subjects?.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>

                        <input type="tel" placeholder="رقم الهاتف" required onChange={e => setFormData({...formData, phone: e.target.value})} />
                        
                        <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg">
                            {loading ? "جاري الحفظ..." : "تأكيد التسجيل"}
                        </button>
                    </form>
                </div>
            );
        };

        // --- 2. لوحة الإدارة (تحتوي على تبويبين) ---
        const AdminPanel = () => {
            const [tab, setTab] = useState('candidates');

            return (
                <div className="p-4 md:p-8">
                    <div className="flex gap-4 mb-8 bg-white p-2 rounded-xl shadow-sm w-fit">
                        <button onClick={() => setTab('candidates')} className={`tab-btn ${tab === 'candidates' ? 'active-tab' : 'text-slate-600'}`}>قائمة المترشحين</button>
                        <button onClick={() => setTab('config')} className={`tab-btn ${tab === 'config' ? 'active-tab' : 'text-slate-600'}`}>إدارة القوائم</button>
                    </div>

                    {tab === 'candidates' ? <CandidatesList /> : <ConfigPanel />}
                </div>
            );
        };

        // --- قائمة المترشحين ---
        const CandidatesList = () => {
            const [data, setData] = useState([]);
            useEffect(() => {
                return db.collection("candidates").orderBy("submittedAt", "desc").onSnapshot(snap => {
                    setData(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
            }, []);

            return (
                <div className="bg-white rounded-xl shadow-lg overflow-x-auto">
                    <table className="w-full admin-table text-right">
                        <thead><tr><th>الاسم</th><th>NIN</th><th>الرتبة</th><th>التخصص</th><th>الهاتف</th></tr></thead>
                        <tbody>
                            {data.map(c => (
                                <tr key={c.id}><td>{c.firstName} {c.lastName}</td><td className="text-xs text-blue-600">{c.nin}</td><td>{c.rank}</td><td>{c.subject}</td><td>{c.phone}</td></tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- لوحة التحكم في القوائم (إضافة وحذف) ---
        const ConfigPanel = () => {
            const [lists, setLists] = useState({ ranks: [], subjects: [] });
            const [newItem, setNewItem] = useState('');

            useEffect(() => {
                return db.collection("settings").doc("lists").onSnapshot(doc => {
                    if (doc.exists) setLists(doc.data());
                });
            }, []);

            const addItem = async (category) => {
                if (!newItem) return;
                await db.collection("settings").doc("lists").set({
                    [category]: firebase.firestore.FieldValue.arrayUnion(newItem)
                }, { merge: true });
                setNewItem('');
            };

            const deleteItem = async (category, item) => {
                await db.collection("settings").doc("lists").update({
                    [category]: firebase.firestore.FieldValue.arrayRemove(item)
                });
            };

            const ListManager = ({ title, items, category }) => (
                <div className="bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                    <h3 className="font-black text-lg mb-4 text-slate-800">{title}</h3>
                    <div className="flex gap-2 mb-4">
                        <input type="text" placeholder="إضافة جديد..." className="!mt-0" value={newItem} onChange={e => setNewItem(e.target.value)} />
                        <button onClick={() => addItem(category)} className="bg-green-600 text-white px-4 rounded-lg font-bold">+</button>
                    </div>
                    <div className="space-y-2">
                        {items?.map(item => (
                            <div key={item} className="flex justify-between items-center bg-slate-50 p-2 rounded border">
                                <span className="font-bold text-sm">{item}</span>
                                <button onClick={() => deleteItem(category, item)} className="text-red-500 font-bold px-2">✕</button>
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="grid md:grid-cols-2 gap-8">
                    <ListManager title="إدارة الرتب" items={lists.ranks} category="ranks" />
                    <ListManager title="إدارة المواد / التخصصات" items={lists.subjects} category="subjects" />
                </div>
            );
        };

        const AdminLogin = () => {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const handleLogin = async (e) => {
                e.preventDefault();
                try { await auth.signInWithEmailAndPassword(email, pass); } catch (err) { alert("بيانات خاطئة"); }
            };
            return (
                <div className="max-w-md mx-auto mt-20 p-8 bg-white rounded-3xl shadow-xl">
                    <h2 className="text-2xl font-black text-center mb-6">دخول الإدارة</h2>
                    <form onSubmit={handleLogin} className="space-y-4">
                        <input type="email" placeholder="البريد" onChange={e => setEmail(e.target.value)} />
                        <input type="password" placeholder="كلمة السر" onChange={e => setPass(e.target.value)} />
                        <button className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">دخول</button>
                    </form>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
